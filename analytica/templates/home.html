<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Analytica - AI-Powered Data Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .sidebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        .main-content {
            background: white;
            min-height: 100vh;
        }
        .chat-panel {
            background: #f8f9fa;
            border-left: 1px solid #dee2e6;
            min-height: 100vh;
        }
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            background:  #f8f9fa;
        }
        .upload-area.dragover {
            border-color: #667eea;
            background: #e3f2fd;
        }
        .file-info {
            background: #e8f5e8;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .dataset-preview {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chat-messages {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
        }
        .message.user {
            background: #e3f2fd;
            margin-left: 20%;
        }
        .message.ai {
            background: #f5f5f5;
            margin-right: 20%;
        }
        .message.typing {
            background: #fff3cd;
            font-style: italic;
        }
        .nav-link {
            color: rgba(255,255,255,0.8);
            transition: all 0.3s ease;
        }
        .nav-link:hover {
            color: white;
            background: rgba(255,255,255,0.1);
        }
        .nav-link.active {
            color: white;
            background: rgba(255,255,255,0.2);
        }
        .processing-status {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .analysis-results {
            background: #e8f5e8;
            border-radius: 8px;
            padding: 15px;
        }
        .chart-container {
            margin: 10px 0;
        }
        .chart-label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #495057;
        }
        .chart-bar {
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            height: 25px;
            line-height: 25px;
            font-family: monospace;
            font-size: 12px;
            color: white;
            text-align: center;
        }
        .chart-fill {
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chart-line, .chart-pie, .chart-box {
            border: 1px solid #dee2e6;
            font-size: 14px;
            line-height: 1.4;
            margin: 15px 0;
        }
        .table-responsive {
            max-height: 300px;
            overflow-y: auto;
        }
        .message .table {
            font-size: 0.9rem;
            margin: 10px 0;
        }
        .message .table td {
            padding: 4px 8px;
            border: 1px solid #dee2e6;
        }
        .message .table th {
            background-color: #f8f9fa;
            font-weight: bold;
            padding: 6px 8px;
        }
        .message ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .message li {
            margin: 2px 0;
        }
        .message h4, .message h5, .message h6 {
            color: #495057;
            margin-top: 15px;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    {% csrf_token %}
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar p-0">
                <div class="p-3">
                    <h4 class="mb-4"><i class="fas fa-chart-line"></i> Analytica</h4>
                    
                    <!-- User Info -->
                    <div class="mb-4 p-3" style="background: rgba(255,255,255,0.1); border-radius: 10px;">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-user-circle fa-2x me-2"></i>
                            <div>
                                <strong>{{ user.username }}</strong>
                                <br><small class="text-light">{{ user.email|default:"No email" }}</small>
                            </div>
                        </div>
                        <div class="mt-2">
                            <a href="{% url 'logout' %}" class="btn btn-sm btn-outline-light w-100">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </a>
                        </div>
                    </div>
                    
                    <nav class="nav flex-column">
                        <a class="nav-link active" href="#"><i class="fas fa-home"></i> Dashboard</a>
                        <a class="nav-link" href="#"><i class="fas fa-upload"></i> Upload Data</a>
                        <a class="nav-link" href="#"><i class="fas fa-cogs"></i> Processing</a>
                        <a class="nav-link" href="#"><i class="fas fa-robot"></i> AI Chat</a>
                        <a class="nav-link" href="#"><i class="fas fa-chart-bar"></i> Analysis</a>
                        <a class="nav-link" href="{% url 'subscription_plans' %}"><i class="fas fa-crown"></i> Plans</a>
                        <a class="nav-link" href="{% url 'my_subscription' %}"><i class="fas fa-user"></i> My Subscription</a>
                    </nav>
                    
                    <!-- Token Usage Display -->
                    <div class="mt-4 p-3" style="background: rgba(255,255,255,0.1); border-radius: 10px;">
                        <h6 class="mb-3"><i class="fas fa-coins"></i> Token Usage</h6>
                        <div id="tokenUsageDisplay">
                            <div class="text-center">
                                <small>Loading usage data...</small>
                            </div>
                        </div>
                        <div class="mt-3">
                            <a href="{% url 'token_dashboard' %}" class="btn btn-sm btn-outline-light w-100">
                                <i class="fas fa-chart-line"></i> View Details
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-6 main-content p-4">
                <h2 class="mb-4">Data Analysis Dashboard</h2>
                
                <!-- File Upload Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-upload"></i> Upload Dataset</h5>
                    </div>
                    <div class="card-body">
                        <form method="post" enctype="multipart/form-data" id="uploadForm">
                            {% csrf_token %}
                            <div class="upload-area" id="uploadArea">
                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                <h5>Drag & Drop your dataset here</h5>
                                <p class="text-muted">or click to browse</p>
                                <input type="file" name="dataset" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
                                <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                                    Choose File
                                </button>
                            </div>
                            <div class="progress mt-3" style="display: none;" id="uploadProgress">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- File Info Section -->
                {% if file_uploaded %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-file-alt"></i> File Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="file-info">
                            <h6><strong>File:</strong> {{ file_info.original_name }}</h6>
                            <p><strong>Size:</strong> {{ file_info.size|filesizeformat }}</p>
                            <p><strong>Uploaded:</strong> {{ file_info.upload_time }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Dataset Preview Section -->
                {% if dataset_info %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-table"></i> Dataset Preview</h5>
                    </div>
                    <div class="card-body">
                        <div class="dataset-preview">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Rows:</strong> {{ dataset_info.rows }}</p>
                                    <p><strong>Columns:</strong> {{ dataset_info.columns }}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Missing Values:</strong> {{ dataset_info.missing_values|length }}</p>
                                    <p><strong>Data Types:</strong> {{ dataset_info.data_types|length }}</p>
                                </div>
                            </div>
                            
                            <h6 class="mt-3">Sample Data:</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            {% for col in dataset_info.column_names %}
                                            <th>{{ col }}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in dataset_info.sample_data %}
                                        <tr>
                                            {% for value in row.values %}
                                            <td>{{ value }}</td>
                                            {% endfor %}
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Process Dataset Button -->
                        <button class="btn btn-success mt-3" onclick="processDataset()" id="processBtn">
                            <i class="fas fa-cogs"></i> Process Dataset
                        </button>
                    </div>
                </div>
                {% endif %}

                <!-- Processing Status -->
                <div class="processing-status" id="processingStatus" style="display: none;">
                    <h6><i class="fas fa-spinner fa-spin"></i> Processing Dataset...</h6>
                    <p>Cleaning data, analyzing structure, and preparing for AI analysis...</p>
                </div>

                                 <!-- Analysis Results -->
                 {% if cleaned_dataset %}
                 <div class="card mb-4">
                     <div class="card-header">
                         <h5><i class="fas fa-chart-bar"></i> Analysis Results</h5>
                     </div>
                     <div class="card-body">
                         <div class="analysis-results">
                             <h6>Cleaning Report:</h6>
                             <ul>
                                 <li><strong>Shape:</strong> {{ cleaned_dataset.shape.0 }} rows × {{ cleaned_dataset.shape.1 }} columns</li>
                                 <li><strong>Columns:</strong> {{ cleaned_dataset.columns|length }}</li>
                                 {% if cleaned_dataset.cleaning_report %}
                                 <li><strong>Missing Values:</strong> {{ cleaned_dataset.cleaning_report.cleaning_summary.total_missing_values }}</li>
                                 <li><strong>Duplicate Rows:</strong> {{ cleaned_dataset.cleaning_report.cleaning_summary.total_duplicate_rows }}</li>
                                 <li><strong>Numeric Columns:</strong> {{ cleaned_dataset.cleaning_report.cleaning_summary.numeric_columns|length }}</li>
                                 <li><strong>Categorical Columns:</strong> {{ cleaned_dataset.cleaning_report.cleaning_summary.categorical_columns|length }}</li>
                                 {% endif %}
                             </ul>
                             
                             <!-- Pass to AI Button -->
                             <button class="btn btn-primary mt-3" onclick="passToAI()" id="passToAIBtn">
                                 <i class="fas fa-robot"></i> Pass to AI
                             </button>
                         </div>
                     </div>
                 </div>
                 {% endif %}
            </div>

                         <!-- AI Chat Panel -->
             <div class="col-md-4 chat-panel p-4">
                 <h4 class="mb-4"><i class="fas fa-robot"></i> AI Assistant</h4>
                 
                 <!-- Dataset Info Display -->
                 {% if ai_ready and file_info %}
                 <div class="card mb-3">
                     <div class="card-header">
                         <h6><i class="fas fa-database"></i> Active Dataset</h6>
                     </div>
                     <div class="card-body">
                         <p><strong>File:</strong> {{ file_info.original_name }}</p>
                         <p><strong>Rows:</strong> {{ dataset_info.rows }}</p>
                         <p><strong>Columns:</strong> {{ dataset_info.columns }}</p>
                         <small class="text-success"><i class="fas fa-check-circle"></i> Data received and ready for analysis</small>
                     </div>
                 </div>
                 {% endif %}
                 
                 <div class="chat-messages" id="chatMessages">
                     <div class="message ai">
                         {% if ai_ready %}
                         <strong>AI Assistant:</strong> Hello! I have received your dataset "{{ file_info.original_name }}" with {{ dataset_info.rows }} rows and {{ dataset_info.columns }} columns. Ask me anything about your data!
                         {% else %}
                         <strong>AI Assistant:</strong> Hello! Upload a dataset and I'll analyze it for you. Ask me anything about your data.
                         {% endif %}
                     </div>
                 </div>
                 
                 <div class="input-group mt-3">
                     <input type="text" class="form-control" id="chatInput" placeholder="Ask me about your dataset..." 
                            {% if not ai_ready %}disabled{% endif %}>
                     <button class="btn btn-primary" type="button" onclick="sendMessage()" 
                             {% if not ai_ready %}disabled{% endif %}>
                         <i class="fas fa-paper-plane"></i>
                     </button>
                 </div>
                 
                 <div class="mt-3">
                     <small class="text-muted">
                         {% if ai_ready %}
                         <i class="fas fa-check-circle text-success"></i> AI ready for analysis
                         {% elif cleaned_dataset %}
                         <i class="fas fa-exclamation-triangle text-warning"></i> Click "Pass to AI" to enable chat
                         {% else %}
                         <i class="fas fa-exclamation-triangle text-warning"></i> Upload and process a dataset first
                         {% endif %}
                     </small>
                 </div>
             </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadForm = document.getElementById('uploadForm');
        const uploadProgress = document.getElementById('uploadProgress');

        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                // Prevent multiple submissions
                const submitButton = uploadForm.querySelector('button[type="submit"]');
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                }
                uploadForm.submit();
            }
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                // Prevent multiple submissions
                const submitButton = uploadForm.querySelector('button[type="submit"]');
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                }
                uploadForm.submit();
            }
        });

                 // Process dataset function
         function processDataset() {
             const processBtn = document.getElementById('processBtn');
             const processingStatus = document.getElementById('processingStatus');
             
             processBtn.disabled = true;
             processBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
             processingStatus.style.display = 'block';
             
             fetch('{% url "process_dataset" %}', {
                 method: 'POST',
                 headers: {
                     'Content-Type': 'application/json',
                     'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                 }
             })
             .then(response => response.json())
             .then(data => {
                 if (data.success) {
                     processingStatus.innerHTML = '<h6><i class="fas fa-check-circle text-success"></i> Processing Complete!</h6><p>Dataset has been cleaned and is ready for AI analysis.</p>';
                     setTimeout(() => {
                         location.reload();
                     }, 2000);
                 } else {
                     processingStatus.innerHTML = '<h6><i class="fas fa-exclamation-triangle text-danger"></i> Processing Failed</h6><p>' + (data.error || 'Unknown error occurred') + '</p>';
                 }
             })
             .catch(error => {
                 processingStatus.innerHTML = '<h6><i class="fas fa-exclamation-triangle text-danger"></i> Processing Failed</h6><p>Network error occurred. Please try again.</p>';
             })
             .finally(() => {
                 processBtn.disabled = false;
                 processBtn.innerHTML = '<i class="fas fa-cogs"></i> Process Dataset';
             });
         }
         
                 // Load token usage data
        function loadTokenUsage() {
            fetch('{% url "api_token_usage" %}')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.usage_summary) {
                        const display = document.getElementById('tokenUsageDisplay');
                        display.innerHTML = `
                            <div class="text-center">
                                <div class="mb-2">
                                    <strong>${data.usage_summary.total_questions}</strong> questions
                                </div>
                                <div class="mb-2">
                                    <strong>${data.usage_summary.total_tokens.toLocaleString()}</strong> tokens
                                </div>
                                <div class="mb-2">
                                    <strong>৳${data.usage_summary.total_cost_bdt.toFixed(2)}</strong> spent
                                </div>
                            </div>
                        `;
                    } else {
                        document.getElementById('tokenUsageDisplay').innerHTML = `
                            <div class="text-center">
                                <small>No usage data available</small>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading token usage:', error);
                    document.getElementById('tokenUsageDisplay').innerHTML = `
                        <div class="text-center">
                            <small>Error loading data</small>
                        </div>
                    `;
                });
        }

        // Load token usage on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadTokenUsage();
        });

        // Pass to AI function
        function passToAI() {
             const passBtn = document.getElementById('passToAIBtn');
             
             passBtn.disabled = true;
             passBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Passing to AI...';
             
             fetch('{% url "pass_to_ai" %}', {
                 method: 'POST',
                 headers: {
                     'Content-Type': 'application/json',
                     'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                 }
             })
             .then(response => response.json())
             .then(data => {
                 if (data.success) {
                     passBtn.innerHTML = '<i class="fas fa-check-circle"></i> Passed to AI';
                     passBtn.className = 'btn btn-success mt-3';
                     
                     // Update chat messages
                     const chatMessages = document.getElementById('chatMessages');
                     chatMessages.innerHTML = `
                         <div class="message ai">
                             <strong>AI Assistant:</strong> Hello! I have received your dataset "${data.dataset_name}" with ${data.rows} rows and ${data.columns} columns. Ask me anything about your data!
                         </div>
                     `;
                     
                     // Enable chat input
                     document.getElementById('chatInput').disabled = false;
                     document.querySelector('button[onclick="sendMessage()"]').disabled = false;
                     
                     // Update status message
                     const statusElement = document.querySelector('.mt-3 small');
                     if (statusElement) {
                         statusElement.innerHTML = '<i class="fas fa-check-circle text-success"></i> AI ready for analysis';
                     }
                     
                     // Add dataset info card
                     const chatPanel = document.querySelector('.chat-panel');
                     const existingCard = chatPanel.querySelector('.card');
                     if (!existingCard) {
                         const datasetCard = document.createElement('div');
                         datasetCard.className = 'card mb-3';
                         datasetCard.innerHTML = `
                             <div class="card-header">
                                 <h6><i class="fas fa-database"></i> Active Dataset</h6>
                             </div>
                             <div class="card-body">
                                 <p><strong>File:</strong> ${data.dataset_name}</p>
                                 <p><strong>Rows:</strong> ${data.rows}</p>
                                 <p><strong>Columns:</strong> ${data.columns}</p>
                                 <small class="text-success"><i class="fas fa-check-circle"></i> Data received and ready for analysis</small>
                             </div>
                         `;
                         chatPanel.insertBefore(datasetCard, chatPanel.querySelector('.chat-messages'));
                     }
                     
                 } else {
                     passBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Failed';
                     passBtn.className = 'btn btn-danger mt-3';
                     setTimeout(() => {
                         passBtn.innerHTML = '<i class="fas fa-robot"></i> Pass to AI';
                         passBtn.className = 'btn btn-primary mt-3';
                         passBtn.disabled = false;
                     }, 3000);
                 }
             })
             .catch(error => {
                 console.error('Pass to AI Error:', error);
                 passBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Failed';
                 passBtn.className = 'btn btn-danger mt-3';
                 setTimeout(() => {
                     passBtn.innerHTML = '<i class="fas fa-robot"></i> Pass to AI';
                     passBtn.className = 'btn btn-primary mt-3';
                     passBtn.disabled = false;
                 }, 3000);
             });
         }

        // Chat functionality
        function addMessage(sender, message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            if (sender === 'user') {
                messageDiv.innerHTML = `<strong>You:</strong> ${message}`;
            } else {
                // Format AI response with proper table rendering and chart display
                let formattedMessage = message;
                
                // Convert markdown-style tables to HTML tables
                // First, find all table blocks (lines starting and ending with |)
                formattedMessage = formattedMessage.replace(/(\|[^|]*\|[\s\S]*?)(?=\n[^|]|$)/g, function(match) {
                    const lines = match.trim().split('\n');
                    let tableHTML = '<table class="table table-sm table-bordered mt-2 mb-2"><tbody>';
                    
                    lines.forEach((line, index) => {
                        if (line.trim().startsWith('|') && line.trim().endsWith('|')) {
                            const cells = line.split('|').slice(1, -1).map(cell => cell.trim());
                            if (index === 1 && line.includes('---')) {
                                // Skip separator line
                                return;
                            }
                            tableHTML += '<tr>' + cells.map(cell => `<td>${cell}</td>`).join('') + '</tr>';
                        }
                    });
                    
                    tableHTML += '</tbody></table>';
                    return tableHTML;
                });
                
                // Convert markdown headers to HTML headers
                formattedMessage = formattedMessage.replace(/^### (.+)$/gm, '<h6 class="mt-3 mb-2">$1</h6>');
                formattedMessage = formattedMessage.replace(/^## (.+)$/gm, '<h5 class="mt-3 mb-2">$1</h5>');
                formattedMessage = formattedMessage.replace(/^# (.+)$/gm, '<h4 class="mt-3 mb-2">$1</h4>');
                
                // Convert markdown lists to HTML lists
                formattedMessage = formattedMessage.replace(/^- (.+)$/gm, '<li>$1</li>');
                formattedMessage = formattedMessage.replace(/(<li>.*<\/li>)/gs, function(match) {
                    return '<ul class="mt-2 mb-2">' + match + '</ul>';
                });
                
                // Convert bold text
                formattedMessage = formattedMessage.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                
                // Convert italic text
                formattedMessage = formattedMessage.replace(/\*(.+?)\*/g, '<em>$1</em>');
                
                // Format ASCII charts with better styling
                // First, clean up any HTML/CSS that might be embedded in the chart strings
                formattedMessage = formattedMessage.replace(/font-family:\s*monospace;\s*background:\s*#[a-fA-F0-9]+;\s*padding:\s*\d+px;\s*border-radius:\s*\d+px;/g, '');
                formattedMessage = formattedMessage.replace(/style="[^"]*"/g, '');
                
                // Enhanced bar charts with █ characters - more flexible pattern
                formattedMessage = formattedMessage.replace(/([^:]+):\s*(█+)\s*\((\d+)\)/g, function(match, label, bars, count) {
                    const percentage = Math.round((bars.length / 20) * 100);
                    return `<div class="chart-container mb-2">
                        <div class="chart-label">${label}:</div>
                        <div class="chart-bar">
                            <div class="chart-fill" style="width: ${percentage}%; background: linear-gradient(90deg, #667eea, #764ba2);">
                                ${bars} (${count})
                            </div>
                        </div>
                    </div>`;
                });
                
                // Simple bar charts without count (kept for backward compatibility or simpler patterns)
                formattedMessage = formattedMessage.replace(/([^:]+):\s*(█+)/g, function(match, label, bars) {
                    const percentage = Math.round((bars.length / 20) * 100);
                    return `<div class="chart-container mb-2">
                        <div class="chart-label">${label}:</div>
                        <div class="chart-bar">
                            <div class="chart-fill" style="width: ${percentage}%; background: linear-gradient(90deg, #667eea, #764ba2);">
                                ${bars} (${bars.length})
                            </div>
                        </div>
                    </div>`;
                });
                
                // Line charts with ─ and │ characters
                formattedMessage = formattedMessage.replace(/([^:]+):\s*([─│●\s]+)/g, function(match, label, chart) {
                    return `<div class="chart-container mb-2">
                        <div class="chart-label">${label}:</div>
                        <div class="chart-line" style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                            ${chart}
                        </div>
                    </div>`;
                });
                
                // Pie charts with ▓ ▒ ░ characters
                formattedMessage = formattedMessage.replace(/([^:]+):\s*([▓▒░]+)/g, function(match, label, chart) {
                    return `<div class="chart-container mb-2">
                        <div class="chart-label">${label}:</div>
                        <div class="chart-pie" style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                            ${chart}
                        </div>
                    </div>`;
                });
                
                // Box plots with ┌─┐│└─┘ characters
                formattedMessage = formattedMessage.replace(/([^:]+):\s*([┌─┐│└─┘\s]+)/g, function(match, label, chart) {
                    return `<div class="chart-container mb-2">
                        <div class="chart-label">${label}:</div>
                        <div class="chart-box" style="font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                            ${chart}
                        </div>
                    </div>`;
                });
                
                // Debug: Log any remaining chart patterns
                console.log('Formatted message:', formattedMessage);
                
                messageDiv.innerHTML = `<strong>AI Assistant:</strong> ${formattedMessage}`;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (message) {
                addMessage('user', message);
                input.value = '';
                
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message ai typing';
                typingDiv.innerHTML = '<strong>AI Assistant:</strong> <em>Typing...</em>';
                document.getElementById('chatMessages').appendChild(typingDiv);
                document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
                
                // Get CSRF token more reliably
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                 document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
                
                if (!csrfToken) {
                    document.querySelector('.typing').remove();
                    addMessage('ai', 'Error: CSRF token not found. Please refresh the page and try again.');
                    return;
                }
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 300000); // 300 second timeout
                
                fetch('{% url "ai_chat" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify({
                        message: message
                    }),
                    signal: controller.signal,
                    credentials: 'same-origin' // Include cookies for CSRF
                })
                .then(response => {
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    document.querySelector('.typing').remove();
                    if (data.success) {
                        addMessage('ai', data.response);
                    } else {
                        addMessage('ai', data.error || 'Sorry, I encountered an error. Please try again.');
                    }
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    document.querySelector('.typing').remove();
                    console.error('AI Chat Error:', error);
                    if (error.name === 'AbortError') {
                        addMessage('ai', 'Response timeout. The AI is taking too long. Please try a simpler question or try again.');
                    } else {
                        addMessage('ai', 'Sorry, I\'m having trouble connecting. Please check if the AI service is running.');
                    }
                });
            }
        }

        // Enter key to send message
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>